-- ThaytuberVN Rayfield‑style Framework v4

local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local Framework = {}
Framework.__index = Framework

-- Tạo viền RGB chạy bao quanh menu rõ ràng (bao 4 cạnh)
local function createRGBFrame(parent)
    local frame = Instance.new("Frame")
    frame.Name = "RGBBorder"
    frame.Position = UDim2.new(0, -4, 0, -4)
    frame.Size = UDim2.new(1, 8, 1, 8)
    frame.BorderSizePixel = 0
    frame.ZIndex = 0
    frame.BackgroundColor3 = Color3.fromHSV(0,1,1)
    frame.Parent = parent

    Instance.new("UICorner", frame).CornerRadius = UDim.new(0,8)

    task.spawn(function()
        local hue = 0
        while frame and frame.Parent do
            hue = (hue + 1) % 360
            frame.BackgroundColor3 = Color3.fromHSV(hue/360,1,1)
            task.wait(0.02)
        end
    end)

    return frame
end

function Framework:CreateWindow(cfg)
    cfg = cfg or {}
    local toggleKey = cfg.ToggleUIKeybind or "K"

    -- Tạo GUI chính
    local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
    gui.Name = "ThaytuberUI"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true

    -- Khung chính
    local main = Instance.new("Frame", gui)
    main.Name = "Main"
    main.Size = UDim2.new(0,500,0,400)
    main.AnchorPoint = Vector2.new(0.5,0.5)
    main.Position = UDim2.new(0.5,0,0.5,0)
    main.BackgroundColor3 = Color3.fromRGB(30,30,30)
    main.ClipsDescendants = false
    main.Visible = false
    Instance.new("UICorner", main).CornerRadius = UDim.new(0,8)

    -- Viền RGB
    local rgbBorder = createRGBFrame(main)
    local rgbEnabled = true

    function main:ToggleRGB(state)
        rgbEnabled = state == nil and not rgbEnabled or state
        rgbBorder.Visible = rgbEnabled
    end

    -- Tab frame và nội dung
    local tabFrame = Instance.new("Frame", main)
    tabFrame.Name = "TabFrame"
    tabFrame.Size = UDim2.new(0,130,1,0)
    tabFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)

    local content = Instance.new("Frame", main)
    content.Name = "Content"
    content.Position = UDim2.new(0,130,0,0)
    content.Size = UDim2.new(1,-130,1,0)
    content.BackgroundTransparency = 1

    local windowData = {
        Main = main,
        Tabs = {},
        Current = nil,
        Key = toggleKey,
    }

    -- Toggle UI khi nhấn phím
    UIS.InputBegan:Connect(function(input, gpe)
        if not gpe and input.KeyCode.Name == windowData.Key then
            if main.Visible then
                TweenService:Create(main, TweenInfo.new(0.2), {Size=UDim2.new(0,0,0,0)}):Play()
                task.wait(0.2)
                main.Visible = false
            else
                main.Size = UDim2.new(0,0,0,0)
                main.Visible = true
                TweenService:Create(main, TweenInfo.new(0.2), {Size=UDim2.new(0,500,0,400)}):Play()
            end
        end
    end)

    -- Kéo UI mượt cả phần nội dung
    do
        local dragging, startPos, startInput
        main.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                startInput = i
                startPos = main.Position
                i.Changed:Connect(function()
                    if i.UserInputState == Enum.UserInputState.End then dragging = false end
                end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = i.Position - startInput.Position
                main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
    end

    -- Hàm tạo tab mới
    function windowData:CreateTab(name)
        if self.Tabs[name] then return self.Tabs[name] end

        local btn = Instance.new("TextButton", tabFrame)
        btn.Name = "Tab_"..name
        btn.Text = name
        btn.Size = UDim2.new(1,-10,0,30)
        btn.Position = UDim2.new(0,5,0,5 + (#tabFrame:GetChildren()-1)*35)
        btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
        btn.TextColor3 = Color3.fromRGB(255,255,255)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 14

        local frame = Instance.new("Frame", content)
        frame.Name = "Content_"..name
        frame.Size = UDim2.new(1,0,1,0)
        frame.Visible = false

        local tab = {Frame = frame}
        function tab:CreateButton(opt)
            local b = Instance.new("TextButton", frame)
            b.Text = opt.Name or ""
            b.Size = UDim2.new(0,200,0,30)
            b.Position = UDim2.new(0,10,0,10 + (#frame:GetChildren()-1)*35)
            b.BackgroundColor3 = Color3.fromRGB(60,60,60)
            b.TextColor3 = Color3.fromRGB(255,255,255)
            b.Font = Enum.Font.Gotham
            b.TextSize = 14
            b.MouseButton1Click:Connect(opt.Callback or function() end)
        end
        function tab:CreateKeybind(opt)
            local b = Instance.new("TextButton", frame)
            b.Name = "KB_"..(opt.Name or "Keybind")
            b.Text = (opt.Name or "Keybind")..": "..windowData.Key
            b.Size = UDim2.new(0,200,0,30)
            b.Position = UDim2.new(0,10,0,10 + (#frame:GetChildren()-1)*35)
            b.BackgroundColor3 = Color3.fromRGB(60,60,60)
            b.TextColor3 = Color3.fromRGB(255,255,255)
            b.Font = Enum.Font.Gotham
            b.TextSize = 14

            b.MouseButton1Click:Connect(function()
                b.Text = (opt.Name or "Keybind")..": ..."
                local conn
                conn = UIS.InputBegan:Connect(function(i,gp)
                    if not gp and i.UserInputType==Enum.UserInputType.Keyboard then
                        windowData.Key = i.KeyCode.Name
                        b.Text = (opt.Name or "Keybind")..": "..windowData.Key
                        conn:Disconnect()
                    end
                end)
            end)
        end

        btn.MouseButton1Click:Connect(function()
            if windowData.Current == frame then
                frame.Visible = false
                windowData.Current = nil
            else
                for _,v in pairs(self.Tabs) do v.Frame.Visible = false end
                frame.Visible = true
                windowData.Current = frame
            end
        end)

        self.Tabs[name] = tab
        return tab
    end

    -- Nút bánh răng mở Settings
    do
        local gear = Instance.new("ImageButton", main)
        gear.Name = "SettingsGear"
        gear.Size = UDim2.new(0,24,0,24)
        gear.Position = UDim2.new(1,-28,0,4)
        gear.BackgroundTransparency = 1
        gear.Image = "rbxassetid://6031091002"

        gear.MouseButton1Click:Connect(function()
            local tab = windowData:CreateTab("Setting")
            for _,v in pairs(windowData.Tabs) do v.Frame.Visible = false end
            tab.Frame.Visible = true
            windowData.Current = tab.Frame
        end)

        -- Tạo sẵn tab Setting
        local sTab = windowData:CreateTab("Setting")
        sTab:CreateKeybind{ Name="Toggle Menu Key" }
        sTab:CreateButton{
            Name = "Toggle RGB Border",
            Callback = function()
                main:ToggleRGB()
            end
        }
    end

    return windowData
end

return Framework

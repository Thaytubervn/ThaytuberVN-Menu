-- ThaytuberVN Framework v3 – Rayfield-style (sửa lỗi CreateKeybind)
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

local Framework = {}
Framework.__index = Framework

-- Tạo viền RGB rõ ràng chạy bao quanh menu
local function createRGBFrame(parent)
    local frame = Instance.new("Frame")
    frame.Name = "RGBBorder"
    frame.Position = UDim2.new(0, -4, 0, -4)
    frame.Size = UDim2.new(1, 8, 1, 8)
    frame.BorderSizePixel = 0
    frame.BackgroundColor3 = Color3.fromHSV(0,1,1)
    frame.ZIndex = 0
    frame.Parent = parent

    local corner = Instance.new("UICorner", frame)
    corner.CornerRadius = UDim.new(0, 8)

    local hue = 0
    local running = true
    coroutine.wrap(function()
        while running and frame.Parent do
            hue = (hue + 1) % 360
            frame.BackgroundColor3 = Color3.fromHSV(hue/360, 1, 1)
            task.wait(0.02)
        end
    end)()

    return frame, function()
        running = false
        if frame and frame.Parent then frame:Destroy() end
    end
end

function Framework:CreateWindow(cfg)
    cfg = cfg or {}
    local keyToggle = cfg.ToggleUIKeybind or "K"

    -- GUI chính
    local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
    gui.Name = "ThaytuberUI"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true

    local main = Instance.new("Frame", gui)
    main.Name = "Main"
    main.Size = UDim2.new(0, 500, 0, 400)
    main.Position = UDim2.new(0.5, 0, 0.5, 0)
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.BackgroundColor3 = Color3.fromRGB(30,30,30)
    main.ClipsDescendants = false
    main.ZIndex = 10
    main.Visible = false

    Instance.new("UICorner", main).CornerRadius = UDim.new(0,8)

    -- Viền RGB
    local rgb, stopRGB
    rgb, stopRGB = createRGBFrame(main)

    -- Khung tab
    local tabFrame = Instance.new("Frame", main)
    tabFrame.Name = "TabFrame"
    tabFrame.Size = UDim2.new(0, 130, 1, 0)
    tabFrame.Position = UDim2.new(0,0,0,0)
    tabFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)

    -- Khung nội dung tab
    local content = Instance.new("Frame", main)
    content.Name = "ContentFrame"
    content.Size = UDim2.new(1, -130, 1, 0)
    content.Position = UDim2.new(0, 130, 0, 0)
    content.BackgroundTransparency = 1

    -- Thao tác kéo menu
    local dragging, dragStart, mainPos
    main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            mainPos = main.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    UIS.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            main.Position = UDim2.new(
                mainPos.X.Scale, mainPos.X.Offset + delta.X,
                mainPos.Y.Scale, mainPos.Y.Offset + delta.Y
            )
        end
    end)

    -- Toggle UI bằng phím
    UIS.InputBegan:Connect(function(input, gpe)
        if not gpe and input.KeyCode.Name == keyToggle then
            if main.Visible then
                TweenService:Create(main, TweenInfo.new(0.2), {Size = UDim2.new(0,0,0,0)}):Play()
                task.wait(0.2)
                main.Visible = false
            else
                main.Size = UDim2.new(0,0,0,0)
                main.Visible = true
                TweenService:Create(main, TweenInfo.new(0.2), {Size = UDim2.new(0,500,0,400)}):Play()
            end
        end
    end)

    local windowData = {
        Main = main,
        TabFrame = tabFrame,
        Content = content,
        Tabs = {},
        Current = nil,
        RGB = {instance = rgb, stop = stopRGB, enabled = true},
        Keybind = keyToggle
    }

    function windowData:ToggleRGB(state)
        self.RGB.enabled = state
        if self.RGB.instance then
            self.RGB.instance.Visible = state
        end
    end

    function windowData:CreateTab(name)
        if windowData.Tabs[name] then return windowData.Tabs[name] end

        local btn = Instance.new("TextButton", tabFrame)
        btn.Name = "TabButton_"..name
        btn.Text = name
        btn.Size = UDim2.new(1, -10, 0, 30)
        btn.Position = UDim2.new(0, 5, 0, 5 + (#tabFrame:GetChildren()-0)*35)
        btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 14

        local frame = Instance.new("Frame", content)
        frame.Name = "Tab_"..name
        frame.Size = UDim2.new(1,0,1,0)
        frame.BackgroundTransparency = 1
        frame.Visible = false

        local Tab = {Frame = frame}
        function Tab:CreateButton(opt)
            local b = Instance.new("TextButton", frame)
            b.Text = opt.Name or ""
            b.Size = UDim2.new(0,200,0,30)
            b.Position = UDim2.new(0,10,0, ( #frame:GetChildren() ) * 35)
            b.BackgroundColor3 = Color3.fromRGB(60,60,60)
            b.TextColor3 = Color3.new(1,1,1)
            b.Font = Enum.Font.Gotham
            b.TextSize = 14
            b.MouseButton1Click:Connect(opt.Callback or function() end)
        end

        function Tab:CreateKeybind(opt)
            local btn = Instance.new("TextButton", frame)
            btn.Text = (opt.Name or "Keybind") .. ": " .. windowData.Keybind
            btn.Size = UDim2.new(0,200,0,30)
            btn.Position = UDim2.new(0,10,0, (#frame:GetChildren()) * 35)
            btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
            btn.TextColor3 = Color3.new(1,1,1)
            btn.Font = Enum.Font.Gotham
            btn.TextSize = 14

            btn.MouseButton1Click:Connect(function()
                btn.Text = (opt.Name or "Keybind")..": ..."
                local conn
                conn = UIS.InputBegan:Connect(function(inp, gpe)
                    if not gpe and inp.UserInputType == Enum.UserInputType.Keyboard then
                        windowData.Keybind = inp.KeyCode.Name
                        btn.Text = (opt.Name or "Keybind")..": "..windowData.Keybind
                        conn:Disconnect()
                    end
                end)
            end)
        end

        btn.MouseButton1Click:Connect(function()
            if windowData.Current == frame then
                frame.Visible = false
                windowData.Current = nil
            else
                for _, v in pairs(windowData.Tabs) do
                    v.Frame.Visible = false
                end
                frame.Visible = true
                windowData.Current = frame
            end
        end)

        windowData.Tabs[name] = Tab
        return Tab
    end

    -- Nút bánh răng mở tab Setting
    local gear = Instance.new("ImageButton", main)
    gear.Name = "SettingsGear"
    gear.Size = UDim2.new(0,24,0,24)
    gear.Position = UDim2.new(1, -28, 0, 4)
    gear.BackgroundTransparency = 1
    gear.Image = "rbxassetid://6031091002"
    gear.MouseButton1Click:Connect(function()
        local tab = windowData:CreateTab("Setting")
        if windowData.Current == tab.Frame then return end
        for _, v in pairs(windowData.Tabs) do v.Frame.Visible = false end
        tab.Frame.Visible = true
        windowData.Current = tab.Frame
    end)

    -- Tạo tab Setting sẵn
    do
        local tab = windowData:CreateTab("Setting")
        tab:CreateKeybind{ Name = "Toggle Menu Key" }
        tab:CreateButton{ Name = "Toggle RGB Border", Callback = function()
            windowData:ToggleRGB(not windowData.RGB.enabled)
        end }
    end

    return windowData
end

return Framework
